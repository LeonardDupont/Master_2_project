%% CareyLab - 2019 - Working Script 3
% This script uses the data extracted in WS1-2 and the speed+tracking data
% to dive into the actual analysis we are interested in.
% Still in the making. 
%
%       (A)  Tracking
%       (B)  TDMS processing 
%       (C)  Speed-based analysis
%       (D)  Point-mutual information (PMI) 
%       (PL) Plotting tools
%
% In order to easily reproduce the performed analysis, this script should
% never be used as such. It should be copied and pasted in a new .m file
% that will only be used for the analysis of a given session. In other
% words, each session analysis should have its own WS script folder
% accompanying the data (see Z).
%
% Contributors : Hugo Marques, Leonard Dupont.
% leonard.dupont@ens.fr
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

%% (Z) Analysis information

WSanalysis.dd =  date; %date of analysis, dday
WSanalysis.mouse = 'MC___'; %please complete
WSanalysis.session = 'SX';


%% (A) - Tracking 
% Uses the Locomouse tracker to get precise behavioural information
options.stride_sorting = 1;
options.compute_gait_parameters = 1;
options.group_parameters_by_distance = 0;
options.group_parameters_by_trial = 0;
options.group_speed_binned_parameters = 0;
options.group_speed_binned_parameters_by_trial = 0;
options.plot_adaptation = 0;
options.plot_tiedbelt = 0;
options.sort_strides_by_speed = 0;  
% considers strides with absolute body speed around zero 
%(i.e. small movement relative to the belt)
options.compute_imu_parameters = 0;
options.sort_front_hind_independently = 1;
% It sets whether strides from the front limbs should be set 
% independently from those of the hind limbs

params_list.gait = ...
    {'stance_length', 'stance_length_rel_body',...
    'stance_length_rel_body_and_belt', 'stance_speed', 'stance_duration',...
    'swing_onset_x_rel','swing_length', 'swing_length_rel_body',...
    'swing_length_rel_body_and_belt', 'swing_speed', 'swing_duration',...
    'stance_onset_x_rel', 'cadence', 'duty_factor', 'double_support',...
    'stride_duration', 'step_length', 'coo_body', 'body_speed',...
    'body_speed_rel', 'stride_length', 'stance_phase',...
    'coo_stance_absolute', 'coo_swing_absolute'};

params_list.gait = {'stance_phase'};
                    
params_list.trajectory = {'swing_rel_x_traj'};
params_list.imu = {'imu_means', 'imu_stds'};

params_list.plot = {'stance_length', 'stance_duration', 'stance_speed', ...
     'swing_duration', 'swing_length', ...
     'double_support', 'step_length', 'coo_body'};

 
tracking_dir = [];
tracking_dir = 'Z:\LocomotionExperiments\RT Self-paced\LocomotorLearning\TM TRACKING FILES\20181018 - water deprived first test';

% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
platform = get_default_widefield_rotary_treadmill_parameters(2);
[dirs] = LocomotionAnalysis(tracking_dir, platform, params_list, options);
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


%% (B) Processing session TDMS files
% TDMS files are metadata files that are created all along the session. TTL
% inputs are written in distinct files to have sampling-frequency
% compatible timestamps across all devices (microscope, behaviour camera,
% belt speed, etc.). 
% Outputs are im, tm, tracking and port_data structs. The 'time' fields can
% be used to have a common timeframe. 


session_raw_dir = 'Z:\leonard.dupont\TM RAW FILES\voluntary locomotion\MC318\S5';
tracking_dir = 'Z:\leonard.dupont\TM TRACKED FILES\MC318\S5';
imaging_dir = 'Z:\leonard.dupont\TM IMAGING FILES\voluntary locomotion\MC318\S5';
session_output_dir = 'Z:\leonard.dupont\TM SESSION FILES\voluntary locomotion\';

[exp_files] = get_experimental_files_ordered_by_animal_session_and_trial(session_raw_dir, '*.tdms');
platform = get_default_widefield_rotary_treadmill_parameters(2);


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
concatenate_session_TDMS_data(exp_files, session_output_dir, platform);
concatenate_session_RTM_treadmill_data(session_output_dir, platform);
concatenate_session_RTM_tracking_data(exp_files, tracking_dir, session_output_dir, platform);
concatenate_session_RTM_imaging_data(exp_files, imaging_dir, session_output_dir, platform);
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -


%% (C) Analysing belt speed
% Hereunder is a rough draft to co-analyse speed variations on the RTM 
% and calcium transients. 
% (C1) First, we take a look at the plot over the whole
% session. Since imaging trials might have been concatenated and separately
% analyse afterwards, we need to concatenate speed trials accordingly. We
% also smooth the speed for readability and analysis purposes. 
% (C2) Then, we define speed categories that we will be able to use later
% one when correlating fluorescence to behaviour. 


% C1 - speed data preprocessing 
calcium_data = cn.intensity.';
m_ca = mean(calcium_data,1);
m_ca = zero_and_max(m_ca);

% Initial plot : over the whole session 
figure, hold on
plot(tm.time,tm.speedM), axis tight
plot(im.time,m_ca)

Nkk = 4; 
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 
speedkk = imbased_konkat(im,tm,Nkk); 
% . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 

if isstruct(speedkk)
    speedkk_struct = speedkk;
    speedkk = speedkk_struct.kk(1); %take the first one 
end

tm_speedMs = smoothdata(speedkk,'gaussian',10000); %smoothed version
figure, plot(tm_speedMs)

spdtime = linspace(1,tm.time(length(tm_speedMs)),length(tm_speedMs)); 
imtime = linspace(1,tm.time(length(tm_speedMs)),length(m_ca));

rescale = max(tm_speedMs);

figure, hold on
plot(spdtime,tm_speedMs), axis tight
plot(imtime,m_ca*rescale)


% C2 - analysing speed categories 
ncat = 3; 
% - - - - - - - -- - - - - - - - - - - -- - - -
speedcats = define_speedcats(tm_speedMs,ncat);

speedlabels = assign_speedlabels(tm_speedMs,speedcats);
ncat = max(speedlabels); %taking in2 account the 0s (make up 1 cat)

speedlabels = get_speedregime_boundaries(speedlabels);



        
axis tight, hold on
plot(linspace(1,length(speedlabels),length(tm_speedMs)),tm_speedMs*(100/max(tm_speedMs)),':','color','k','LineWidth',1)


plot(linspace(1,length(speedlabels),length(m_ca)),m_ca*(100/max(m_ca)),'color','k','LineWidth',0.001)
box off 
yticklabels = [];


%% Consider saving the workspace?

wkspacename = ['WS1_workspace',WSanalysis.dd,WSanalysis.mouse,WSanalysis.session]; 
save(wkspacename)